#!/usr/bin/env bash

export WD=$PWD

if [ "$(uname -s)" = "Darwin" ]; then
    alias ls="ls --color=auto"
    alias ll="ls -l"
else
    alias open="xdg-open"
fi

if [ ! -f "$WD/.jsinit" ]; then
    npm install --save-dev jshint
    touch "$WD/.jsinit"
fi

sedtrailing () {
    sed -i 's/[ \t]\+$//' "$1"
}

export -f sedtrailing

htmlall () {
    find \
        "$WD" \
        -type f \
        -name '*.html' \
        -not -path "$WD/node_modules/*" \
        -exec bash -c '
            echo "$1"
            tidy -config "$WD/.tidyrc" -q -m "$1"
            sedtrailing "$1"
        ' bash {} \;
}

jsall () {
    # shellcheck disable=SC1004
    find \
        "$WD" \
        -type f \
        -name '*.js' \
        -not -path "$WD/node_modules/*" \
        -exec bash -c '
            echo "$1"
            "$WD/node_modules/jshint/bin/jshint" \
                --verbose \
                -c "$WD/.jshintrc" \
                "$1"
            clang-format -i "$1"
        ' bash {} \;
}

export -f htmlall
export -f jsall
